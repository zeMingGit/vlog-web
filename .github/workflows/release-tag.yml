name: Create Release and Tag

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:

jobs:
  create-release:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Format tag name
      id: format_tag
      run: |
        # è·å–PRæ ‡é¢˜å¹¶æ¸…ç†ç‰¹æ®Šå­—ç¬¦
        PR_TITLE="${{ github.event.pull_request.title }}"
        # ç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œåªä¿ç•™å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦å’Œä¸‹åˆ’çº¿
        CLEAN_TITLE=$(echo "$PR_TITLE" | sed 's/[^a-zA-Z0-9_-]/_/g' | sed 's/__*/_/g' | sed 's/^_//' | sed 's/_$//')
        # ç¡®ä¿é•¿åº¦åˆé€‚ï¼ˆGitæ ‡ç­¾å»ºè®®ä¸è¶…è¿‡128å­—ç¬¦ï¼‰
        if [ ${#CLEAN_TITLE} -gt 100 ]; then
          CLEAN_TITLE=$(echo "$CLEAN_TITLE" | cut -c1-100)
        fi
        echo "tag_name=$CLEAN_TITLE" >> $GITHUB_OUTPUT
        echo "original_title=$PR_TITLE" >> $GITHUB_OUTPUT
        echo "Formatted tag name: $CLEAN_TITLE"
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.format_tag.outputs.tag_name }}
        release_name: ${{ steps.format_tag.outputs.original_title }}
        body: |
          ## ğŸ“š å°æ£±é•œå‰ç«¯å­¦ä¹ æ–‡æ¡£æ›´æ–°
            
          ### ğŸš€ æ›´æ–°å†…å®¹
          - ${{ steps.format_tag.outputs.original_title }}
          
          ### ğŸ“‹ PR ä¿¡æ¯
          - PR æ ‡é¢˜: ${{ steps.format_tag.outputs.original_title }}
          - PR ç¼–å·: #${{ github.event.pull_request.number }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - åˆå¹¶è€…: ${{ github.event.pull_request.merged_by.login }}
          - Tag åç§°: ${{ steps.format_tag.outputs.tag_name }}
          
          ### ğŸ“ PR æè¿°
          ${{ github.event.pull_request.body }}
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [PR è¯¦æƒ…](https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }})
          - [GitHub ä»“åº“](https://github.com/${{ github.repository }})
          
          ---
          *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
        draft: false
        prerelease: false